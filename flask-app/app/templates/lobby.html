{% extends 'base.html' %}

{% block title %}{{ game['name'] }} - Lobby{% endblock %}

{% block content %}
<h1>{{ game['name'] }} - Lobby</h1>
<h3>Game ID: {{ game['_id'] }}</h3>
<h2>Players:</h2>
<ul id="players-list">
    {% for player in players %}
    <li>
        {{ player['username'] }},
        {{ player['color'] }} - {% if player['isReady'] %} Ready {% else %} Not Ready {% endif %}
    </li>
    {% endfor %}
</ul>
<h2>Select Your Color:</h2>
<form method="POST">

    <select name="color" required>
        {% for color in available_colors %}
            <option value="{{ color }}">{{ color.capitalize() }}</option>
        {% endfor %}
    </select>
    <button type="submit">Join Lobby</button>
</form>

<form method="POST" action="{{ url_for('game.update_player_status', game_id=game['_id']) }}">
    <button type="submit">Toggle Ready Status</button>
</form>
<form method="POST" action="{{ url_for('game.leave_game', game_id=game['_id']) }}">
    <button type="submit">Leave Game</button>
</form>

<!-- Button for starting the game -->
<form method="POST" action="{{ url_for('game.start') }}">
    <input name="game_id" type="text" value="{{ game['_id'] }}"   />
    <button type="submit">Start Game</button>
</form>

<script>
    const eventSource = new EventSource("{{ url_for('game.lobby_stream', game_id=game['_id']) }}");
    eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);
        const playersList = document.querySelector("ul#players-list");
        playersList.innerHTML = ""; // Clear the current list

        data.players.forEach(p => {
            const li = document.createElement("li");
            li.textContent = 
                `${p.username}, ${p.color} - ${p.isReady ? "Ready" : "Not Ready"}`;
            playersList.appendChild(li);
        });

        const startGameButton = document.getElementById("start-game-button");
        if (data.allReady) {
            startGameButton.style.display = "block";
        } else {
            startGameButton.style.display = "none";
        }
    };
</script>
{% endblock %}
